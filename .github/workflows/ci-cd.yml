name: CI/CD Pipeline

on:
  push:
    branches:
      - feature/**
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build & Test Monorepo.
    runs-on: ubuntu-latest

    env:
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: innogram
          POSTGRES_USER: innogram_user
          POSTGRES_PASSWORD: innogram_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U innogram_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
          - 15672:15672
        env:
          RABBITMQ_DEFAULT_USER: innogram
          RABBITMQ_DEFAULT_PASS: innogram_password

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install root dependencies
        run: npm ci

      - name: Turbo prune
        run: npx turbo prune --scope=core_microservice --docker

      - name: Install pruned dependencies
        working-directory: ./out
        run: npm ci

      - name: Build core microservice
        working-directory: ./out
        run: npm run build -- --filter=core_microservice

      - name: Run tests (if present)
        working-directory: ./out
        run: npm run test --if-present


  docker-core:
    name: Build & Push core_microservice image (GHCR)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push core_microservice image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/core_microservice/Dockerfile
          push: true
          tags: |
            ghcr.io/pawelnowicki87/intern_project/core_microservice:latest

  docker-auth:
    name: Build & Push auth_microservice image (GHCR)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push auth_microservice image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/auth_microservice/Dockerfile
          push: true
          tags: |
            ghcr.io/pawelnowicki87/intern_project/auth_microservice:latest


  docker-notifications:
    name: Build & Push notifications_consumer_microservice image (GHCR)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push notifications_consumer_microservice image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/notifications_consumer_microservice/Dockerfile
          push: true
          tags: |
            ghcr.io/pawelnowicki87/intern_project/notifications_consumer_microservice:latest

  deploy:
    name: Deploy to AWS EC2 (docker-compose)
    runs-on: ubuntu-latest
    needs:
      - docker-core
      - docker-auth
      - docker-notifications
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u pawelnowicki87 --password-stdin
            cd /home/ubuntu
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            docker image prune -f


